<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nutrition Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #8b5cf6;
            --accent: #ec4899;
            --success: #10b981;
            --danger: #ef4444;
            --dark: #1e293b;
            --gray: #64748b;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 32px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.15);
        }

        h1 {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
            font-size: 2.5em;
            font-weight: 800;
        }

        .date {
            color: var(--gray);
            margin-bottom: 32px;
            font-size: 0.95em;
        }

        .setup-section {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            padding: 24px;
            border-radius: 20px;
            margin-bottom: 28px;
            border: 2px solid rgba(245, 158, 11, 0.3);
        }

        .setup-section h3 {
            margin-bottom: 12px;
        }

        .setup-section input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid rgba(0,0,0,0.1);
            border-radius: 12px;
            margin-top: 8px;
            background: white;
        }

        .daily-summary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 32px;
            border-radius: 24px;
            margin-bottom: 32px;
            box-shadow: 0 10px 40px rgba(99, 102, 241, 0.3);
        }

        .daily-summary h2 {
            font-size: 1.4em;
            margin-bottom: 20px;
        }

        .macro-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 16px;
        }

        .macro-item {
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            padding: 20px 16px;
            border-radius: 16px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .macro-value {
            font-size: 2.2em;
            font-weight: 800;
            margin-bottom: 6px;
        }

        .macro-label {
            font-size: 0.9em;
            opacity: 0.95;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .action-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 16px;
            margin-bottom: 32px;
        }

        .btn {
            padding: 18px 24px;
            border: none;
            border-radius: 16px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            color: white;
        }

        .btn:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(0,0,0,0.15);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
        }

        .btn-tertiary {
            background: linear-gradient(135deg, var(--accent) 0%, #db2777 100%);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(4px);
            z-index: 1000;
            padding: 20px;
            overflow-y: auto;
        }

        .modal-content {
            background: white;
            max-width: 600px;
            margin: 50px auto;
            padding: 36px;
            border-radius: 28px;
            position: relative;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .close {
            position: absolute;
            top: 20px;
            right: 24px;
            font-size: 28px;
            cursor: pointer;
            color: var(--gray);
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .close:hover {
            background: #f1f5f9;
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--dark);
        }

        .form-group input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1em;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
        }

        .food-log h2 {
            font-size: 1.5em;
            color: var(--dark);
            margin-bottom: 20px;
            font-weight: 700;
        }

        .food-item {
            background: white;
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #e2e8f0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }

        .food-item:hover {
            box-shadow: 0 8px 24px rgba(0,0,0,0.08);
            transform: translateY(-2px);
        }

        .food-info {
            flex: 1;
        }

        .food-name {
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 6px;
            font-size: 1.05em;
        }

        .food-macros {
            font-size: 0.9em;
            color: var(--gray);
            font-weight: 500;
        }

        .delete-btn {
            background: var(--danger);
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
        }

        .delete-btn:hover {
            background: #dc2626;
        }

        .image-preview {
            max-width: 100%;
            border-radius: 16px;
            margin: 20px 0;
            box-shadow: 0 8px 24px rgba(0,0,0,0.1);
        }

        .loading {
            display: none;
            text-align: center;
            padding: 24px;
            color: var(--primary);
        }

        .spinner {
            border: 4px solid #e2e8f0;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 48px;
            height: 48px;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 12px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #fee2e2;
            color: #991b1b;
            padding: 16px;
            border-radius: 12px;
            margin: 12px 0;
            border-left: 4px solid var(--danger);
        }

        input[type="file"] {
            display: none;
        }

        .file-upload-btn {
            display: block;
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            text-align: center;
            border-radius: 16px;
            cursor: pointer;
            font-weight: 600;
        }

        .file-upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(99, 102, 241, 0.3);
        }

        #reader {
            border-radius: 16px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .barcode-input {
            margin-top: 15px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 24px;
            }
            
            h1 {
                font-size: 2em;
            }
            
            .action-buttons {
                grid-template-columns: 1fr;
            }

            .macro-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ü•ó Nutrition Tracker</h1>
        <div class="date" id="currentDate"></div>

        <div class="setup-section" id="apiSetupSection">
            <h3>‚öôÔ∏è Photo Analysis (Optional)</h3>
            <p style="font-size: 0.9em; margin-bottom: 12px;">Enable AI meal analysis</p>
            <p style="font-size: 0.85em; color: #666; margin-bottom: 8px;">Get API key at <a href="https://console.anthropic.com" target="_blank">console.anthropic.com</a></p>
            <input type="password" id="apiKeyInput" placeholder="sk-ant-api03-...">
            <button class="btn btn-primary" onclick="saveApiKey()" style="width: 100%; margin-top: 8px;">Save API Key</button>
        </div>

        <div class="daily-summary">
            <h2>Today's Nutrition</h2>
            <div class="macro-grid">
                <div class="macro-item">
                    <div class="macro-value" id="totalCalories">0</div>
                    <div class="macro-label">Calories</div>
                </div>
                <div class="macro-item">
                    <div class="macro-value" id="totalProtein">0g</div>
                    <div class="macro-label">Protein</div>
                </div>
                <div class="macro-item">
                    <div class="macro-value" id="totalCarbs">0g</div>
                    <div class="macro-label">Carbs</div>
                </div>
                <div class="macro-item">
                    <div class="macro-value" id="totalFat">0g</div>
                    <div class="macro-label">Fat</div>
                </div>
            </div>
        </div>

        <div class="action-buttons">
            <button class="btn btn-primary" onclick="openManualEntry()">
                <span>‚ûï</span>
                <span>Manual Entry</span>
            </button>
            <button class="btn btn-secondary" onclick="openBarcodeScanner()">
                <span>üì∑</span>
                <span>Scan Barcode</span>
            </button>
            <button class="btn btn-tertiary" onclick="openMealPhoto()">
                <span>üçΩÔ∏è</span>
                <span>Photo Analysis</span>
            </button>
        </div>

        <div class="food-log">
            <h2>Today's Log</h2>
            <div id="foodLogContainer"></div>
        </div>
    </div>

    <!-- Manual Entry Modal -->
    <div id="manualModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('manualModal')">&times;</span>
            <h2>Manual Entry</h2>
            <div class="form-group">
                <label>Food Name</label>
                <input type="text" id="manualFoodName" placeholder="e.g., Chicken Breast">
            </div>
            <div class="form-group">
                <label>Portion Size</label>
                <input type="text" id="manualPortion" placeholder="e.g., 200g">
            </div>
            <div class="form-group">
                <label>Calories</label>
                <input type="number" id="manualCalories" placeholder="0">
            </div>
            <div class="form-group">
                <label>Protein (g)</label>
                <input type="number" id="manualProtein" placeholder="0">
            </div>
            <div class="form-group">
                <label>Carbs (g)</label>
                <input type="number" id="manualCarbs" placeholder="0">
            </div>
            <div class="form-group">
                <label>Fat (g)</label>
                <input type="number" id="manualFat" placeholder="0">
            </div>
            <button class="btn btn-primary" onclick="addManualEntry()" style="width: 100%;">Add to Log</button>
        </div>
    </div>

    <!-- Barcode Modal -->
    <div id="barcodeModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeBarcodeScanner()">&times;</span>
            <h2>Scan Barcode</h2>
            <p style="margin-bottom: 15px; color: #666;">Point your camera at a barcode</p>
            <div id="reader" style="width: 100%;"></div>
            <div class="loading" id="barcodeLoading">
                <div class="spinner"></div>
                <p>Looking up product...</p>
            </div>
            <div id="barcodeResult"></div>
        </div>
    </div>

    <!-- Photo Modal -->
    <div id="photoModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('photoModal')">&times;</span>
            <h2>Meal Photo Analysis</h2>
            <div id="photoError" class="error" style="display: none;"></div>
            <label for="mealPhoto" class="file-upload-btn">
                üì∏ Choose or Take Photo
            </label>
            <input type="file" id="mealPhoto" accept="image/*" capture="environment" onchange="analyzeMealPhoto()">
            <div id="photoPreview"></div>
            <div class="loading" id="photoLoading">
                <div class="spinner"></div>
                <p>Analyzing your meal...</p>
            </div>
            <div id="photoResult"></div>
        </div>
    </div>

    <!-- Load barcode scanner library -->
    <script src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    
    <script>
        let html5QrCode = null;
        let currentDate = new Date().toISOString().split('T')[0];
        
        document.getElementById('currentDate').textContent = new Date().toLocaleDateString('en-US', { 
            weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
        });

        function loadData() {
            const data = JSON.parse(localStorage.getItem('nutritionData') || '{}');
            if (!data[currentDate]) data[currentDate] = [];
            return data;
        }

        function saveData(data) {
            localStorage.setItem('nutritionData', JSON.stringify(data));
            updateSummary();
            renderFoodLog();
        }

        function saveApiKey() {
            const apiKey = document.getElementById('apiKeyInput').value.trim();
            if (apiKey && apiKey.startsWith('sk-ant-')) {
                localStorage.setItem('anthropicApiKey', apiKey);
                alert('‚úì API Key saved!');
            } else if (apiKey) {
                alert('Please enter a valid Anthropic API key');
            }
        }

        function checkApiKey() {
            const apiKey = localStorage.getItem('anthropicApiKey');
            if (apiKey) document.getElementById('apiKeyInput').value = apiKey;
        }

        function openManualEntry() {
            document.getElementById('manualModal').style.display = 'block';
        }

        function openBarcodeScanner() {
            document.getElementById('barcodeModal').style.display = 'block';
            // Small delay to ensure modal is visible before starting camera
            setTimeout(startBarcodeScanner, 300);
        }

        function openMealPhoto() {
            const apiKey = localStorage.getItem('anthropicApiKey');
            if (!apiKey) {
                alert('Please set up your Anthropic API key first!');
                return;
            }
            document.getElementById('photoModal').style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            if (modalId === 'manualModal') {
                document.getElementById('manualFoodName').value = '';
                document.getElementById('manualPortion').value = '';
                document.getElementById('manualCalories').value = '';
                document.getElementById('manualProtein').value = '';
                document.getElementById('manualCarbs').value = '';
                document.getElementById('manualFat').value = '';
            }
            if (modalId === 'photoModal') {
                document.getElementById('photoPreview').innerHTML = '';
                document.getElementById('photoResult').innerHTML = '';
                document.getElementById('mealPhoto').value = '';
                document.getElementById('photoError').style.display = 'none';
            }
        }

        function closeBarcodeScanner() {
            if (html5QrCode && html5QrCode.isScanning) {
                html5QrCode.stop().then(() => {
                    closeModal('barcodeModal');
                    document.getElementById('barcodeResult').innerHTML = '';
                }).catch(() => {
                    closeModal('barcodeModal');
                    document.getElementById('barcodeResult').innerHTML = '';
                });
            } else {
                closeModal('barcodeModal');
            }
        }

        function startBarcodeScanner() {
            // Check if library is loaded
            if (typeof Html5Qrcode === 'undefined') {
                document.getElementById('barcodeResult').innerHTML = 
                    '<div class="error">Barcode scanner library failed to load. Please refresh the page.<br><br>Or enter barcode manually:<br><input type="text" id="manualBarcode" placeholder="Enter barcode number" style="width: 100%; padding: 10px; margin: 10px 0; border: 2px solid #e2e8f0; border-radius: 8px;"><button class="btn btn-primary" onclick="lookupManualBarcode()" style="width: 100%;">Look Up</button></div>';
                return;
            }

            try {
                html5QrCode = new Html5Qrcode("reader");
                
                const config = { 
                    fps: 10, 
                    qrbox: { width: 250, height: 250 },
                    aspectRatio: 1.0
                };
                
                html5QrCode.start(
                    { facingMode: "environment" },
                    config,
                    async (decodedText) => {
                        // Success! Found a barcode
                        await lookupBarcode(decodedText);
                    },
                    (errorMessage) => {
                        // Scanning errors (can ignore these)
                    }
                ).catch(err => {
                    console.error("Camera error:", err);
                    document.getElementById('barcodeResult').innerHTML = 
                        '<div class="error">Camera access denied or unavailable.<br><br>Please:<br>1. Enable camera permissions for this site<br>2. Make sure you\'re using HTTPS or localhost<br><br>Or enter barcode manually:<br><input type="text" id="manualBarcode" placeholder="Enter barcode number" style="width: 100%; padding: 10px; margin: 10px 0; border: 2px solid #e2e8f0; border-radius: 8px;"><button class="btn btn-primary" onclick="lookupManualBarcode()" style="width: 100%;">Look Up</button></div>';
                });
            } catch (error) {
                console.error("Scanner initialization error:", error);
                document.getElementById('barcodeResult').innerHTML = 
                    '<div class="error">Failed to initialize scanner. Enter barcode manually:<br><input type="text" id="manualBarcode" placeholder="Enter barcode number" style="width: 100%; padding: 10px; margin: 10px 0; border: 2px solid #e2e8f0; border-radius: 8px;"><button class="btn btn-primary" onclick="lookupManualBarcode()" style="width: 100%;">Look Up</button></div>';
            }
        }

        function lookupManualBarcode() {
            const barcode = document.getElementById('manualBarcode').value.trim();
            if (barcode) {
                lookupBarcode(barcode);
            }
        }

        async function lookupBarcode(barcode) {
            document.getElementById('barcodeLoading').style.display = 'block';
            
            try {
                const response = await fetch(`https://world.openfoodfacts.org/api/v2/product/${barcode}.json`);
                const data = await response.json();
                
                document.getElementById('barcodeLoading').style.display = 'none';
                
                if (data.status === 1) {
                    displayBarcodeResult(data.product);
                } else {
                    document.getElementById('barcodeResult').innerHTML = 
                        '<div class="error">Product not found in database. Try manual entry.</div>';
                }
            } catch (error) {
                document.getElementById('barcodeLoading').style.display = 'none';
                document.getElementById('barcodeResult').innerHTML = 
                    '<div class="error">Error looking up product. Please try again.</div>';
            }
        }

        function displayBarcodeResult(product) {
            const n = product.nutriments;
            const html = `
                <div style="background: #f7fafc; padding: 15px; border-radius: 10px; margin-top: 15px;">
                    <h3>${product.product_name || 'Unknown'}</h3>
                    <p><strong>Brand:</strong> ${product.brands || 'Unknown'}</p>
                    <hr style="margin: 15px 0;">
                    <p><strong>Per 100g:</strong></p>
                    <p>Calories: ${Math.round(n.energy_value || n['energy-kcal_100g'] || 0)} kcal</p>
                    <p>Protein: ${(n.proteins_100g || 0).toFixed(1)}g</p>
                    <p>Carbs: ${(n.carbohydrates_100g || 0).toFixed(1)}g</p>
                    <p>Fat: ${(n.fat_100g || 0).toFixed(1)}g</p>
                    
                    <div class="form-group" style="margin-top: 15px;">
                        <label>How much did you eat? (grams)</label>
                        <input type="number" id="barcodeAmount" value="100">
                    </div>
                    
                    <button class="btn btn-primary" onclick="addBarcodeEntry()" style="width: 100%; margin-top: 10px;">
                        Add to Log
                    </button>
                </div>
            `;
            document.getElementById('barcodeResult').innerHTML = html;
            
            window.currentBarcodeProduct = {
                name: product.product_name || 'Unknown',
                brand: product.brands || '',
                calories: Math.round(n.energy_value || n['energy-kcal_100g'] || 0),
                protein: n.proteins_100g || 0,
                carbs: n.carbohydrates_100g || 0,
                fat: n.fat_100g || 0
            };
        }

        function addBarcodeEntry() {
            const amount = parseFloat(document.getElementById('barcodeAmount').value) || 100;
            const product = window.currentBarcodeProduct;
            const mult = amount / 100;
            
            const entry = {
                id: Date.now(),
                name: `${product.name}${product.brand ? ' (' + product.brand + ')' : ''}`,
                portion: `${amount}g`,
                calories: Math.round(product.calories * mult),
                protein: Math.round(product.protein * mult * 10) / 10,
                carbs: Math.round(product.carbs * mult * 10) / 10,
                fat: Math.round(product.fat * mult * 10) / 10,
                timestamp: new Date().toISOString()
            };
            
            const data = loadData();
            data[currentDate].push(entry);
            saveData(data);
            closeBarcodeScanner();
        }

        function addManualEntry() {
            const entry = {
                id: Date.now(),
                name: document.getElementById('manualFoodName').value,
                portion: document.getElementById('manualPortion').value,
                calories: parseFloat(document.getElementById('manualCalories').value) || 0,
                protein: parseFloat(document.getElementById('manualProtein').value) || 0,
                carbs: parseFloat(document.getElementById('manualCarbs').value) || 0,
                fat: parseFloat(document.getElementById('manualFat').value) || 0,
                timestamp: new Date().toISOString()
            };

            if (!entry.name) {
                alert('Please enter a food name');
                return;
            }

            const data = loadData();
            data[currentDate].push(entry);
            saveData(data);
            closeModal('manualModal');
        }

        async function analyzeMealPhoto() {
            const file = document.getElementById('mealPhoto').files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('photoPreview').innerHTML = 
                    `<img src="${e.target.result}" class="image-preview">`;
            };
            reader.readAsDataURL(file);
            
            document.getElementById('photoLoading').style.display = 'block';
            document.getElementById('photoResult').innerHTML = '';
            document.getElementById('photoError').style.display = 'none';
            
            try {
                const base64 = await fileToBase64(file);
                const apiKey = localStorage.getItem('anthropicApiKey');
                
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': apiKey,
                        'anthropic-version': '2023-06-01'
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 1024,
                        messages: [{
                            role: 'user',
                            content: [
                                {
                                    type: 'image',
                                    source: {
                                        type: 'base64',
                                        media_type: file.type,
                                        data: base64.split(',')[1]
                                    }
                                },
                                {
                                    type: 'text',
                                    text: 'Analyze this meal and estimate nutrition. Respond in JSON: {"items": [{"name": "...", "portion": "...", "calories": 0, "protein": 0, "carbs": 0, "fat": 0}], "notes": "..."}'
                                }
                            ]
                        }]
                    })
                });
                
                if (!response.ok) throw new Error('API request failed');
                
                const result = await response.json();
                const text = result.content[0].text;
                const match = text.match(/\{[\s\S]*\}/);
                if (match) {
                    displayPhotoResult(JSON.parse(match[0]));
                } else {
                    throw new Error('Could not parse response');
                }
                
            } catch (error) {
                document.getElementById('photoError').textContent = `Error: ${error.message}`;
                document.getElementById('photoError').style.display = 'block';
            } finally {
                document.getElementById('photoLoading').style.display = 'none';
            }
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function displayPhotoResult(analysis) {
            let html = '<div style="background: #f7fafc; padding: 15px; border-radius: 10px;"><h3>Analysis</h3>';
            if (analysis.notes) html += `<p style="color: #666; font-style: italic; margin-bottom: 15px;">${analysis.notes}</p>`;
            
            analysis.items.forEach(item => {
                html += `<div style="background: white; padding: 12px; border-radius: 8px; margin-bottom: 10px;">
                    <strong>${item.name}</strong> (${item.portion})<br>
                    <small>${item.calories} cal | ${item.protein}g protein | ${item.carbs}g carbs | ${item.fat}g fat</small>
                </div>`;
            });
            
            html += `<button class="btn btn-primary" onclick="addPhotoEntries()" style="width: 100%; margin-top: 15px;">Add All</button></div>`;
            document.getElementById('photoResult').innerHTML = html;
            window.currentPhotoAnalysis = analysis;
        }

        function addPhotoEntries() {
            const data = loadData();
            window.currentPhotoAnalysis.items.forEach(item => {
                data[currentDate].push({
                    id: Date.now() + Math.random(),
                    name: item.name,
                    portion: item.portion,
                    calories: item.calories,
                    protein: item.protein,
                    carbs: item.carbs,
                    fat: item.fat,
                    timestamp: new Date().toISOString()
                });
            });
            saveData(data);
            closeModal('photoModal');
        }

        function updateSummary() {
            const data = loadData();
            const today = data[currentDate] || [];
            const totals = today.reduce((acc, item) => ({
                calories: acc.calories + (item.calories || 0),
                protein: acc.protein + (item.protein || 0),
                carbs: acc.carbs + (item.carbs || 0),
                fat: acc.fat + (item.fat || 0)
            }), { calories: 0, protein: 0, carbs: 0, fat: 0 });
            
            document.getElementById('totalCalories').textContent = Math.round(totals.calories);
            document.getElementById('totalProtein').textContent = Math.round(totals.protein) + 'g';
            document.getElementById('totalCarbs').textContent = Math.round(totals.carbs) + 'g';
            document.getElementById('totalFat').textContent = Math.round(totals.fat) + 'g';
        }

        function renderFoodLog() {
            const data = loadData();
            const today = data[currentDate] || [];
            const container = document.getElementById('foodLogContainer');
            
            if (today.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">No entries yet!</p>';
                return;
            }
            
            container.innerHTML = today.map(item => `
                <div class="food-item">
                    <div class="food-info">
                        <div class="food-name">${item.name}</div>
                        <div class="food-macros">
                            ${item.portion ? item.portion + ' ‚Ä¢ ' : ''}
                            ${item.calories} cal ‚Ä¢ P: ${item.protein}g ‚Ä¢ C: ${item.carbs}g ‚Ä¢ F: ${item.fat}g
                        </div>
                    </div>
                    <button class="delete-btn" onclick="deleteEntry(${item.id})">Delete</button>
                </div>
            `).reverse().join('');
        }

        function deleteEntry(id) {
            if (!confirm('Delete this entry?')) return;
            const data = loadData();
            data[currentDate] = data[currentDate].filter(item => item.id !== id);
            saveData(data);
        }

        checkApiKey();
        updateSummary();
        renderFoodLog();
    </script>
</body>
</html>
